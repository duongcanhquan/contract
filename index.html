<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Test T√¨m Ki·∫øm D·ªØ Li·ªáu N8N</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 30px; background-color: #f9f9f9; }
        h2 { color: #333; }
        .box { background: white; border: 1px solid #ddd; padding: 0; margin-top: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-height: 300px; overflow-y: auto; }
        input { padding: 12px; width: 100%; max-width: 400px; font-size: 16px; border: 2px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        input:focus { border-color: #007bff; outline: none; }
        #status { font-weight: bold; margin-bottom: 15px; }
        .item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .item:hover { background-color: #e3f2fd; color: #0056b3; }
        
        /* Khu v·ª±c hi·ªÉn th·ªã chi ti·∫øt */
        #detail-area { 
            background: #fff; 
            padding: 20px; 
            display: none; 
            margin-top: 20px; 
            border-left: 5px solid #28a745; 
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .detail-row { margin-bottom: 10px; font-size: 16px; }
        .detail-label { font-weight: bold; color: #555; width: 120px; display: inline-block; }
    </style>
</head>
<body>

    <h2>üõ†Ô∏è TRA C·ª®U H·ª¢P ƒê·ªíNG & NH√ÇN S·ª∞</h2>
    
    <div id="status" style="color:orange">‚è≥ ƒêang k·∫øt n·ªëi t·ªõi N8N...</div>

    <input type="text" id="searchInp" placeholder="üîç Nh·∫≠p T√™n, Email ho·∫∑c SƒêT ƒë·ªÉ t√¨m..." disabled>

    <div id="resultList" class="box" style="display:none"></div>

    <div id="detail-area">
        <h3 style="margin-top:0">‚úÖ K·∫øt qu·∫£ tra c·ª©u:</h3>
        <div class="detail-row"><span class="detail-label">H·ªç v√† T√™n:</span> <span id="out_name"></span></div>
        <div class="detail-row"><span class="detail-label">Email:</span> <span id="out_email"></span></div>
        <div class="detail-row"><span class="detail-label">ƒêi·ªán tho·∫°i:</span> <span id="out_phone"></span></div>
        <div class="detail-row"><span class="detail-label">CMND/CCCD:</span> <span id="out_cmnd"></span></div>
        <div class="detail-row"><span class="detail-label">Ng√†y sinh:</span> <span id="out_dob"></span></div>
        <div class="detail-row"><span class="detail-label">H·ª£p ƒë·ªìng:</span> <span id="out_contract"></span></div>
    </div>

    <script>
        // üî¥ LINK API C·ª¶A B·∫†N (GI·ªÆ NGUY√äN)
        const API_URL = "https://apchn-host.lapage.vn/webhook/api-get-candidates"; 

        let database = []; 
        const statusDiv = document.getElementById('status');
        const searchInp = document.getElementById('searchInp');
        const resultList = document.getElementById('resultList');
        const detailArea = document.getElementById('detail-area');

        // 1. T·∫¢I D·ªÆ LI·ªÜU T·ª™ N8N
        fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                // X·ª≠ l√Ω d·ªØ li·ªáu ƒë·∫ßu v√†o (ph√≤ng tr∆∞·ªùng h·ª£p N8N tr·∫£ v·ªÅ c√°c d·∫°ng kh√°c nhau)
                let rawData = [];
                if (Array.isArray(data)) rawData = data;
                else if (data.data && Array.isArray(data.data)) rawData = data.data;
                else rawData = [data];

                // L·∫•y d·ªØ li·ªáu s·∫°ch (b·ªè wrapper .json n·∫øu c√≥)
                database = rawData.map(item => item.json ? item.json : item);

                if (database.length > 0) {
                    statusDiv.innerText = `‚úÖ ƒê√£ t·∫£i xong ${database.length} h·ªì s∆°! S·∫µn s√†ng tra c·ª©u.`;
                    statusDiv.style.color = "green";
                    searchInp.disabled = false;
                    searchInp.focus();
                } else {
                    statusDiv.innerText = "‚ö†Ô∏è K·∫øt n·ªëi th√†nh c√¥ng nh∆∞ng kh√¥ng c√≥ d·ªØ li·ªáu (0 d√≤ng).";
                }
            })
            .catch(err => {
                statusDiv.innerText = "‚ùå L·ªói k·∫øt n·ªëi: " + err.message;
                statusDiv.style.color = "red";
            });

        // 2. X·ª¨ L√ù T√åM KI·∫æM
        searchInp.addEventListener('input', function() {
            const keyword = this.value.toLowerCase().trim();
            resultList.innerHTML = ''; 
            detailArea.style.display = 'none';

            if (keyword.length < 1) {
                resultList.style.display = 'none';
                return;
            }

            resultList.style.display = 'block';

            // L·ªçc d·ªØ li·ªáu: T√¨m trong t·∫•t c·∫£ c√°c c·ªôt
            const ketQua = database.filter(dong => {
                const textData = Object.values(dong).join(' ').toLowerCase();
                return textData.includes(keyword);
            });

            if (ketQua.length === 0) {
                resultList.innerHTML = '<div style="padding:15px; color:gray">Kh√¥ng t√¨m th·∫•y ai...</div>';
            } else {
                ketQua.forEach(nguoi => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    
                    // üëâ TR√çCH XU·∫§T D·ªÆ LI·ªÜU ƒê·ªÇ HI·ªÇN TH·ªä DANH S√ÅCH (S·ª≠ d·ª•ng ƒë√∫ng t√™n c·ªôt b·∫°n cung c·∫•p)
                    const ten = nguoi['H·ªç v√† T√™n/ Name'] || 'Kh√¥ng t√™n';
                    const email = nguoi['Email c√° nh√¢n/ Email'] || '';
                    
                    div.innerHTML = `<strong>${ten}</strong> <span style='color:#777; font-size:0.9em'>(${email})</span>`;
                    
                    // Khi b·∫•m v√†o t√™n ng∆∞·ªùi n√†o -> Hi·ªán chi ti·∫øt
                    div.onclick = () => hienThiChiTiet(nguoi);
                    
                    resultList.appendChild(div);
                });
            }
        });

        // 3. H√ÄM HI·ªÇN TH·ªä CHI TI·∫æT (MAP ƒê√öNG KEY C·ª¶A GOOGLE SHEET)
        function hienThiChiTiet(nguoi) {
            detailArea.style.display = 'block';
            resultList.style.display = 'none'; // ·∫®n danh s√°ch g·ª£i √Ω ƒëi cho g·ªçn
            searchInp.value = ''; // X√≥a √¥ t√¨m ki·∫øm

            // üëâ ƒê√ÇY L√Ä PH·∫¶N QUAN TR·ªåNG NH·∫§T: G√ÅN ƒê√öNG T√äN C·ªòT
            document.getElementById('out_name').innerText = nguoi['H·ªç v√† T√™n/ Name'] || '';
            document.getElementById('out_email').innerText = nguoi['Email c√° nh√¢n/ Email'] || '';
            document.getElementById('out_phone').innerText = nguoi['S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá/ Phone number'] || '';
            document.getElementById('out_cmnd').innerText = nguoi['S·ªë CMND/ ID'] || '';
            document.getElementById('out_dob').innerText = nguoi['Ng√†y sinh/ Date of birth'] || '';
            document.getElementById('out_contract').innerText = nguoi['Lo·∫°i H·ª£p ƒê·ªìng/ Type of Contract'] || '';
        }
    </script>

</body>
</html>
