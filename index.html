<script>
    // üî¥ LINK API C·ª¶A B·∫†N
    const API_URL = "https://apchn-host.lapage.vn/webhook/api-get-candidates"; 

    let database = []; 
    const statusDiv = document.getElementById('status');
    const searchInp = document.getElementById('searchInp');
    const resultList = document.getElementById('resultList');
    const detailArea = document.getElementById('detail-area');

    // 1. T·∫¢I D·ªÆ LI·ªÜU
    fetch(API_URL)
        .then(response => response.json())
        .then(data => {
            // X·ª≠ l√Ω d·ªØ li·ªáu d√π N8N tr·∫£ v·ªÅ d·∫°ng n√†o
            let rawData = [];
            if (Array.isArray(data)) rawData = data;
            else if (data.data && Array.isArray(data.data)) rawData = data.data;
            else rawData = [data];

            // L√†m s·∫°ch d·ªØ li·ªáu (B·ªè l·ªõp v·ªè .json n·∫øu c√≥)
            database = rawData.map(item => item.json ? item.json : item);

            if (database.length > 0) {
                statusDiv.innerText = `‚úÖ ƒê√£ t·∫£i xong ${database.length} d√≤ng d·ªØ li·ªáu! H√£y g√µ t√¨m ki·∫øm.`;
                statusDiv.style.color = "green";
                searchInp.disabled = false;
                
                // üõ†Ô∏è IN T√äN C√ÅC C·ªòT RA M√ÄN H√åNH ƒê·ªÇ B·∫†N NH√åN TH·∫§Y
                const firstItem = database[0];
                const columnNames = Object.keys(firstItem).join(" | ");
                
                const debugBox = document.createElement('div');
                debugBox.style.cssText = "background:#fff3cd; color:#856404; padding:10px; margin-top:10px; font-size:13px; border:1px solid #ffeeba;";
                debugBox.innerHTML = `<strong>‚ö†Ô∏è M√ÅY T√çNH ƒêANG TH·∫§Y C√ÅC C·ªòT T√äN L√Ä:</strong><br>${columnNames}`;
                statusDiv.appendChild(debugBox);
                
            } else {
                statusDiv.innerText = "‚ö†Ô∏è K·∫øt n·ªëi th√†nh c√¥ng nh∆∞ng file r·ªóng (0 d√≤ng).";
            }
        })
        .catch(err => {
            statusDiv.innerText = "‚ùå L·ªói: " + err.message;
            statusDiv.style.color = "red";
        });

    // 2. T√åM KI·∫æM (B·∫§T CH·∫§P T√äN C·ªòT)
    searchInp.addEventListener('input', function() {
        const keyword = this.value.toLowerCase().trim();
        resultList.innerHTML = ''; 
        detailArea.style.display = 'none';

        if (keyword.length < 1) return;

        // L·ªçc d·ªØ li·ªáu: Bi·∫øn c·∫£ d√≤ng th√†nh chu·ªói text ƒë·ªÉ t√¨m
        const ketQua = database.filter(dong => {
            // L·∫•y t·∫•t c·∫£ gi√° tr·ªã, n·ªëi l·∫°i th√†nh 1 c√¢u d√†i r·ªìi t√¨m
            const textData = Object.values(dong).join(' ').toLowerCase();
            return textData.includes(keyword);
        });

        if (ketQua.length === 0) {
            resultList.innerHTML = '<div style="color:gray">Kh√¥ng t√¨m th·∫•y ai...</div>';
        } else {
            ketQua.forEach(nguoi => {
                const div = document.createElement('div');
                div.className = 'item';
                
                // Hi·ªÉn th·ªã t√≥m t·∫Øt: L·∫•y 2 gi√° tr·ªã ƒë·∫ßu ti√™n t√¨m th·∫•y ƒë·ªÉ hi·ªÉn th·ªã
                const vals = Object.values(nguoi);
                div.innerText = `üë§ ${vals[0]} - üìß ${vals[1] || '...'}`;
                
                div.onclick = () => hienThiChiTiet(nguoi);
                resultList.appendChild(div);
            });
        }
    });

    // 3. HI·ªÇN TH·ªä CHI TI·∫æT
    function hienThiChiTiet(nguoi) {
        detailArea.style.display = 'block';
        
        // T·ª± ƒë·ªông in t·∫•t c·∫£ th√¥ng tin ra (v√¨ ch∆∞a bi·∫øt t√™n c·ªôt ch√≠nh x√°c)
        let htmlContent = '<h3>‚úÖ Th√¥ng tin chi ti·∫øt:</h3>';
        for (const [key, value] of Object.entries(nguoi)) {
            htmlContent += `<p><strong>${key}:</strong> ${value}</p>`;
        }
        detailArea.innerHTML = htmlContent;
    }
</script>
