<script>
    // üî¥ 1. LINK API C·ª¶A B·∫†N
    const API_URL = "https://apchn-host.lapage.vn/webhook/api-get-candidates"; 

    let database = []; 
    const statusDiv = document.getElementById('status');
    const searchInp = document.getElementById('searchInp');
    const resultList = document.getElementById('resultList');
    const detailArea = document.getElementById('detail-area');

    // --- H√ÄM 1: L·∫§Y D·ªÆ LI·ªÜU ---
    fetch(API_URL)
        .then(response => response.json())
        .then(data => {
            console.log("D·ªØ li·ªáu g·ªëc t·ª´ N8N:", data); // Xem F12 ƒë·ªÉ bi·∫øt chi ti·∫øt

            // Chu·∫©n h√≥a d·ªØ li·ªáu: X·ª≠ l√Ω tr∆∞·ªùng h·ª£p N8N tr·∫£ v·ªÅ d·∫°ng {json: ...} ho·∫∑c m·∫£ng ph·∫≥ng
            let rawData = [];
            if (Array.isArray(data)) {
                rawData = data;
            } else if (data.data && Array.isArray(data.data)) {
                rawData = data.data;
            } else {
                // Tr∆∞·ªùng h·ª£p n8n tr·∫£ v·ªÅ object l·∫ª
                rawData = [data]; 
            }

            // M·∫πo quan tr·ªçng: N·∫øu d·ªØ li·ªáu b·ªã b·ªçc trong {json: ...}, ta l√¥i n√≥ ra
            database = rawData.map(item => {
                return item.json ? item.json : item;
            });

            if (database.length > 0) {
                statusDiv.innerText = `‚úÖ ƒê√£ t·∫£i xong ${database.length} d√≤ng!`;
                statusDiv.style.color = "green";
                searchInp.disabled = false;
                
                // üõ†Ô∏è DEBUG: HI·ªÇN TH·ªä T√äN C√ÅC C·ªòT RA M√ÄN H√åNH ƒê·ªÇ B·∫†N KI·ªÇM TRA
                const keys = Object.keys(database[0]).join(", ");
                const debugMsg = document.createElement('div');
                debugMsg.style.background = "#fff3cd";
                debugMsg.style.padding = "10px";
                debugMsg.style.fontSize = "12px";
                debugMsg.innerHTML = `<strong>‚ö†Ô∏è M√°y t√≠nh ƒëang nh√¨n th·∫•y c√°c c·ªôt t√™n l√†:</strong> <br> ${keys}`;
                statusDiv.appendChild(debugMsg);
            } else {
                statusDiv.innerText = "‚ö†Ô∏è K·∫øt n·ªëi th√†nh c√¥ng nh∆∞ng danh s√°ch r·ªóng (0 d√≤ng).";
            }
        })
        .catch(err => {
            statusDiv.innerText = "‚ùå L·ªói k·∫øt n·ªëi: " + err.message;
            statusDiv.style.color = "red";
            console.error(err);
        });

    // --- H√ÄM 2: T√åM KI·∫æM (CHI√äU CU·ªêI: T√åM B·∫§T CH·∫§P) ---
    searchInp.addEventListener('input', function() {
        const keyword = this.value.toLowerCase().trim();
        resultList.innerHTML = ''; 
        detailArea.style.display = 'none';

        if (keyword.length < 1) return;

        // L·ªçc d·ªØ li·ªáu: Chuy·ªÉn c·∫£ d√≤ng th√†nh chu·ªói text r·ªìi t√¨m
        // C√°ch n√†y b·∫•t ch·∫•p t√™n c·ªôt l√† g√¨, c·ª© c√≥ ch·ªØ l√† t√¨m ra.
        const ketQua = database.filter(dong => {
            const stringData = JSON.stringify(dong).toLowerCase();
            return stringData.includes(keyword);
        });

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        if (ketQua.length === 0) {
            resultList.innerHTML = '<div style="color:gray">Kh√¥ng t√¨m th·∫•y...</div>';
        } else {
            ketQua.forEach(nguoi => {
                const div = document.createElement('div');
                div.className = 'item';
                
                // ‚ö†Ô∏è L∆ØU √ù: ·ªû ƒë√¢y t√¥i ƒëang ƒëo√°n t√™n c·ªôt. 
                // Sau khi ch·∫°y code n√†y, b·∫°n h√£y nh√¨n d√≤ng ch·ªØ v√†ng tr√™n m√†n h√¨nh ƒë·ªÉ s·ª≠a l·∫°i t√™n c·ªôt d∆∞·ªõi ƒë√¢y cho ƒë√∫ng
                // V√≠ d·ª•: nguoi['T√™n'] ho·∫∑c nguoi['H·ªç v√† t√™n']...
                
                // T·∫°m th·ªùi hi·ªÉn th·ªã to√†n b·ªô n·ªôi dung d√≤ng ƒë√≥ ƒë·ªÉ b·∫°n ch·∫Øc ch·∫Øn nh√¨n th·∫•y d·ªØ li·ªáu
                const previewText = Object.values(nguoi).join(" - "); 
                div.innerText = `üë§ ${previewText}`;
                
                div.onclick = () => hienThiChiTiet(nguoi);
                resultList.appendChild(div);
            });
        }
    });

    // --- H√ÄM 3: HI·ªÇN TH·ªä CHI TI·∫æT ---
    function hienThiChiTiet(nguoi) {
        detailArea.style.display = 'block';
        
        // B·∫°n c·∫ßn thay ƒë√∫ng t√™n c·ªôt d·ª±a v√†o d√≤ng ch·ªØ v√†ng "DEBUG" hi·ªán ra tr√™n m√†n h√¨nh
        // V√≠ d·ª• m√°y hi·ªán: "Name, Email, Phone" th√¨ b·∫°n s·ª≠a b√™n d∆∞·ªõi th√†nh nguoi['Name']...
        
        // T·∫°m th·ªùi t√¥i d√πng c√°ch an to√†n: In c·ªôt ƒë·∫ßu ti√™n t√¨m th·∫•y
        const keys = Object.keys(nguoi);
        document.getElementById('out_name').innerText = nguoi[keys[0]] || "Ch∆∞a r√µ c·ªôt"; 
        document.getElementById('out_email').innerText = nguoi['Email'] || nguoi['email'] || "Ki·ªÉm tra l·∫°i t√™n c·ªôt Email";
        document.getElementById('out_phone').innerText = nguoi['Phone'] || nguoi['SƒêT'] || "...";
        document.getElementById('out_cmnd').innerText = "...";
    }
</script>
