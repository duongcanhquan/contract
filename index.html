<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tra C·ª©u Nh√¢n S·ª± (Fix V·ªã Tr√≠)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; }
        
        input { padding: 14px; width: 100%; box-sizing: border-box; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 6px; outline: none; transition: 0.3s; }
        input:focus { border-color: #3498db; box-shadow: 0 0 8px rgba(52,152,219,0.2); }
        
        #status { text-align: center; margin: 15px 0; font-weight: 600; }
        
        /* Danh s√°ch k·∫øt qu·∫£ */
        #resultList { margin-top: 15px; max-height: 400px; overflow-y: auto; display: none; border: 1px solid #eee; border-radius: 6px; }
        .item { padding: 12px 15px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .item:hover { background-color: #e8f4fc; }
        .item-name { font-weight: bold; color: #2c3e50; font-size: 15px; }
        .item-email { color: #7f8c8d; font-size: 13px; }

        /* B·∫£ng chi ti·∫øt */
        #detail-area { background: #fff; border: 1px solid #27ae60; padding: 20px; border-radius: 8px; margin-top: 20px; display: none; position: relative; }
        #detail-area h3 { margin-top: 0; color: #27ae60; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .row { margin-bottom: 12px; display: flex; }
        .label { font-weight: bold; width: 140px; color: #555; flex-shrink: 0; }
        .val { color: #333; word-break: break-word; }
        .close-btn { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 20px; color: #aaa; }
        .close-btn:hover { color: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ†Ô∏è C√îNG C·ª§ TRA C·ª®U NH√ÇN S·ª∞</h2>
    <div id="status" style="color:orange">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>

    <input type="text" id="searchInp" placeholder="üîç G√µ t√™n ho·∫∑c email ƒë·ªÉ t√¨m..." disabled>
    
    <div id="resultList"></div>

    <div id="detail-area">
        <span class="close-btn" onclick="dongChiTiet()">√ó</span>
        <h3>‚úÖ Th√¥ng tin chi ti·∫øt</h3>
        <div class="row"><span class="label">H·ªç v√† T√™n:</span> <span class="val" id="out_name"></span></div>
        <div class="row"><span class="label">Email:</span> <span class="val" id="out_email"></span></div>
        <div class="row"><span class="label">S·ªë ƒëi·ªán tho·∫°i:</span> <span class="val" id="out_phone"></span></div>
        <div class="row"><span class="label">H·ª£p ƒë·ªìng:</span> <span class="val" id="out_contract"></span></div>
        <div class="row"><span class="label">Gi·ªõi t√≠nh:</span> <span class="val" id="out_gender"></span></div>
        <div class="row"><span class="label">D·ªØ li·ªáu th√¥:</span> <span class="val" id="out_raw" style="font-size:11px; color:#999"></span></div>
    </div>
</div>

<script>
    // üî¥ LINK API C·ª¶A B·∫†N
    const API_URL = "https://apchn-host.lapage.vn/webhook/api-get-candidates"; 

    let database = []; 
    // Bi·∫øn l∆∞u T√™n C·ªôt (Key)
    let KEY_NAME = ""; 
    let KEY_EMAIL = "";
    let KEY_PHONE = "";
    let KEY_CONTRACT = "";
    let KEY_GENDER = "";

    const statusDiv = document.getElementById('status');
    const searchInp = document.getElementById('searchInp');
    const resultList = document.getElementById('resultList');
    const detailArea = document.getElementById('detail-area');

    // 1. T·∫¢I D·ªÆ LI·ªÜU
    fetch(API_URL)
        .then(response => response.json())
        .then(data => {
            let rawData = [];
            if (Array.isArray(data)) rawData = data;
            else if (data.data && Array.isArray(data.data)) rawData = data.data;
            else rawData = [data];

            database = rawData.map(item => item.json ? item.json : item);

            if (database.length > 0) {
                // üî• CHI·∫æN THU·∫¨T L·∫§Y THEO V·ªä TR√ç C·ªòT (INDEX) üî•
                // D·ª±a tr√™n ·∫£nh Google Sheet c·ªßa b·∫°n:
                // C·ªôt A (Index 0): Timestamp
                // C·ªôt B (Index 1): H·ªç v√† T√™n (TARGET)
                // C·ªôt C (Index 2): Lo·∫°i H·ª£p ƒê·ªìng
                // C·ªôt D (Index 3): Gi·ªõi t√≠nh
                // C·ªôt F (Index 5): S·ªë ƒëi·ªán tho·∫°i
                // C·ªôt G (Index 6): Email
                
                const sampleRow = database[0];
                const allKeys = Object.keys(sampleRow); // L·∫•y danh s√°ch t√™n c·ªôt
                
                // G√°n c·ª©ng theo v·ªã tr√≠ ƒë·ªÉ tr√°nh sai t√™n
                // L∆∞u √Ω: N·∫øu n8n tr·∫£ v·ªÅ th·ª© t·ª± ƒë√∫ng th√¨ keys[1] ch√≠nh l√† C·ªôt B
                KEY_NAME = allKeys[1];      // C·ªôt B
                KEY_CONTRACT = allKeys[2];  // C·ªôt C
                KEY_GENDER = allKeys[3];    // C·ªôt D
                
                // Ri√™ng Email v√† SƒêT m√¨nh t√¨m theo t√™n cho ch·∫Øc ƒÉn v√¨ n√≥ ·ªü xa
                KEY_PHONE = allKeys.find(k => k.toLowerCase().includes("phone") || k.toLowerCase().includes("ƒëi·ªán tho·∫°i")) || allKeys[5];
                KEY_EMAIL = allKeys.find(k => k.toLowerCase().includes("email")) || allKeys[6];

                statusDiv.innerHTML = `‚úÖ ƒê√£ t·∫£i ${database.length} h·ªì s∆°.<br><span style="font-size:12px; font-weight:normal; color:#555">ƒêang l·∫•y c·ªôt T√™n l√†: [${KEY_NAME}]</span>`;
                statusDiv.style.color = "green";
                searchInp.disabled = false;
                searchInp.focus();
            } else {
                statusDiv.innerText = "‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu.";
            }
        })
        .catch(err => {
            statusDiv.innerText = "‚ùå L·ªói: " + err.message;
            statusDiv.style.color = "red";
        });

    // 2. T√åM KI·∫æM
    searchInp.addEventListener('input', function() {
        const keyword = this.value.toLowerCase().trim();
        resultList.innerHTML = ''; 
        dongChiTiet();

        if (keyword.length < 1) {
            resultList.style.display = 'none';
            return;
        }

        // T√¨m trong T√™n ho·∫∑c Email
        const ketQua = database.filter(dong => {
            const ten = String(dong[KEY_NAME] || '').toLowerCase();
            const email = String(dong[KEY_EMAIL] || '').toLowerCase();
            return ten.includes(keyword) || email.includes(keyword);
        });

        resultList.style.display = 'block';

        if (ketQua.length === 0) {
            resultList.innerHTML = '<div style="padding:15px; color:#999; text-align:center">Kh√¥ng t√¨m th·∫•y ai...</div>';
        } else {
            ketQua.forEach(nguoi => {
                const div = document.createElement('div');
                div.className = 'item';
                
                // Hi·ªÉn th·ªã d√πng ƒë√∫ng Key ƒë√£ b·∫Øt ƒë∆∞·ª£c
                div.innerHTML = `
                    <span class="item-name">${nguoi[KEY_NAME]}</span>
                    <span class="item-email">${nguoi[KEY_EMAIL] || 'Kh√¥ng c√≥ email'}</span>
                `;
                
                div.onclick = () => hienThiChiTiet(nguoi);
                resultList.appendChild(div);
            });
        }
    });

    // 3. HI·ªÇN TH·ªä CHI TI·∫æT
    function hienThiChiTiet(nguoi) {
        detailArea.style.display = 'block';
        resultList.style.display = 'none'; // ·∫®n danh s√°ch
        
        document.getElementById('out_name').innerText = nguoi[KEY_NAME] || '';
        document.getElementById('out_email').innerText = nguoi[KEY_EMAIL] || '';
        document.getElementById('out_phone').innerText = nguoi[KEY_PHONE] || '';
        document.getElementById('out_contract').innerText = nguoi[KEY_CONTRACT] || '';
        document.getElementById('out_gender').innerText = nguoi[KEY_GENDER] || '';
        
        // In to√†n b·ªô d√≤ng ƒë√≥ ra ƒë·ªÉ debug n·∫øu c·∫ßn
        document.getElementById('out_raw').innerText = JSON.stringify(nguoi);
    }

    function dongChiTiet() {
        detailArea.style.display = 'none';
    }
</script>

</body>
</html>
