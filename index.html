<!DOCTYPE html>
<html lang="vi">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THÔNG TIN NHÂN SỰ - APCHN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0056b3; 
            --bg-color: #f0f2f5;
            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        body { 
            background-color: var(--bg-color); 
            font-family: 'Roboto', sans-serif; 
            color: #333;
            padding-bottom: 40px;
        }

        .main-container {
            max-width: 960px;
            margin: 20px auto;
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        /* Header Logo Section */
        .header-banner {
            background: white;
            padding: 30px 20px;
            text-align: center;
            border-bottom: 3px solid var(--primary-color);
        }

        .logo-img {
            max-width: 300px;
            height: auto;
            margin-bottom: 10px;
            display: inline-block;
        }

        .form-title {
            color: #b71c1c;
            font-weight: 700;
            font-size: 1.6rem;
            text-transform: uppercase;
            margin-bottom: 0;
            margin-top: 10px;
        }

        /* Form Styling */
        .form-padding {
            padding: 30px;
        }

        .section-header {
            background-color: #e3f2fd;
            color: #0d47a1;
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 700;
            margin-top: 25px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            border-left: 5px solid #0d47a1;
        }

        .form-label {
            font-weight: 500;
            font-size: 0.95rem;
            color: #495057;
            margin-bottom: 5px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.25);
            border-color: #0d47a1;
        }

        /* Nút Gửi */
        .btn-submit-wrapper {
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .btn-submit {
            background: linear-gradient(45deg, #0d47a1, #1976d2);
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(13, 71, 161, 0.4);
            transition: transform 0.2s;
            color: white;
        }

        .btn-submit:active {
            transform: scale(0.98);
        }

        /* Mobile Optimization */
        @media (max-width: 576px) {
            .main-container {
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            .form-padding {
                padding: 20px 15px;
            }
            .logo-img {
                max-width: 200px;
            }
            .form-title {
                font-size: 1.3rem;
            }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header-banner">
            <img src="https://raw.githubusercontent.com/duongcanhquan/image/main/logo%20vietmy.webp" alt="Logo Viet My" class="logo-img">
            <h1 class="form-title">THÔNG TIN NHÂN SỰ / HR PROFILE</h1>
            <p class="text-muted mt-2 mb-0">Hệ thống quản lý hồ sơ tập trung</p>
        </div>

        <div class="form-padding">
            <form id="hrForm" autocomplete="off">
                
                <div class="section-header">1. Thông tin cá nhân / Personal Info</div>
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Họ và tên / Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="ho_ten" placeholder="Nhập chữ in hoa..." required style="text-transform: uppercase;">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Giới tính / Gender <span class="text-danger">*</span></label>
                        <select class="form-select" name="gioi_tinh" required>
                            <option value="">--Chọn--</option>
                            <option value="Nam">Nam / Male</option>
                            <option value="Nữ">Nữ / Female</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Quốc tịch</label>
                        <input type="text" class="form-control" name="quoc_tich" value="Việt Nam">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Ngày sinh / DOB <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="ngay_sinh" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nơi sinh / Place of Birth</label>
                        <input type="text" class="form-control" name="noi_sinh">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Số điện thoại / Phone <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" name="so_dien_thoai" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Email cá nhân <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Tình trạng hôn nhân</label>
                        <select class="form-select" name="hon_nhan">
                            <option value="Độc thân">Độc thân / Single</option>
                            <option value="Đã kết hôn">Đã kết hôn / Married</option>
                            <option value="Ly hôn">Ly hôn / Divorced</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Địa chỉ thường trú / Permanent Address</label>
                        <input type="text" class="form-control" name="dia_chi_thuong_tru">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Nơi ở hiện tại / Current Address</label>
                        <input type="text" class="form-control" name="noi_o_hien_tai">
                    </div>
                </div>

                <div class="section-header">2. Giấy tờ tùy thân / ID Card</div>
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Số CCCD / ID Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="so_cccd" required>
                    </div>
                    <div class="col-6 col-md-4">
                        <label class="form-label">Ngày Cấp</label>
                        <input type="date" class="form-control" name="ngay_cap_cccd">
                    </div>
                    <div class="col-6 col-md-4">
                        <label class="form-label">Nơi cấp</label>
                        <input type="text" class="form-control" name="noi_cap_cccd">
                    </div>
                </div>

                <div class="section-header">3. Trình độ học vấn / Education</div>
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Trình độ cao nhất</label>
                        <select class="form-select" name="trinh_do">
                            <option value="Đại học">Đại học</option>
                            <option value="Cao đẳng">Cao đẳng</option>
                            <option value="Thạc Sỹ">Thạc Sỹ</option>
                            <option value="Tiến Sỹ">Tiến Sỹ</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Chuyên ngành</label>
                        <input type="text" class="form-control" name="chuyen_nganh">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Trường đào tạo</label>
                        <input type="text" class="form-control" name="truong_dao_tao">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Bằng cấp khác (nếu có)</label>
                        <input type="text" class="form-control" name="bang_cap_khac">
                    </div>
                </div>

                <div class="section-header">4. Tài chính & Pháp lý / Finance & Legal</div>
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Tên chủ tài khoản</label>
                        <input type="text" class="form-control" name="ten_tk_ngan_hang" style="text-transform: uppercase;">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Số tài khoản</label>
                        <input type="text" class="form-control" name="so_tk_ngan_hang">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Ngân hàng - Chi nhánh</label>
                        <input type="text" class="form-control" name="chi_nhanh_ngan_hang" placeholder="VD: VCB - CN Ba Đình">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Mã số thuế cá nhân</label>
                        <input type="text" class="form-control" name="mst_ca_nhan">
                    </div>
                    <div class="col-6 col-md-4">
                        <label class="form-label">Nơi cấp MST</label>
                        <input type="text" class="form-control" name="noi_cap_mst">
                    </div>
                    <div class="col-6 col-md-4">
                        <label class="form-label">Ngày cấp MST</label>
                        <input type="date" class="form-control" name="ngay_cap_mst">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Số sổ BHXH (Nếu có)</label>
                        <input type="text" class="form-control" name="so_bhxh" placeholder="Giảng viên thỉnh giảng bỏ qua">
                    </div>
                </div>

                <div class="section-header">5. Gia đình / Family</div>
                <div class="mb-3">
                    <label class="form-label text-primary fw-bold">Thông tin con (Họ tên - Ngày sinh)</label>
                    <div class="row g-2">
                        <div class="col-12"><input type="text" class="form-control" name="con_1" placeholder="Con 1..."></div>
                        <div class="col-12"><input type="text" class="form-control" name="con_2" placeholder="Con 2..."></div>
                        <div class="col-12"><input type="text" class="form-control" name="con_3" placeholder="Con 3..."></div>
                    </div>
                </div>
                
                <div class="mb-3">
                     <label class="form-label text-primary fw-bold">Người phụ thuộc (Giảm trừ gia cảnh)</label>
                     <div class="card p-2 bg-light mb-2">
                        <div class="row g-2">
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="npt_1_ten" placeholder="Họ tên NPT 1"></div>
                            <div class="col-6"><input type="text" class="form-control form-control-sm" name="npt_1_mst" placeholder="MST NPT 1"></div>
                            <div class="col-6"><input type="text" class="form-control form-control-sm" name="npt_1_qh" placeholder="Mối quan hệ"></div>
                        </div>
                     </div>
                     <div class="card p-2 bg-light">
                        <div class="row g-2">
                            <div class="col-12"><input type="text" class="form-control form-control-sm" name="npt_2_ten" placeholder="Họ tên NPT 2"></div>
                            <div class="col-6"><input type="text" class="form-control form-control-sm" name="npt_2_mst" placeholder="MST NPT 2"></div>
                            <div class="col-6"><input type="text" class="form-control form-control-sm" name="npt_2_qh" placeholder="Mối quan hệ"></div>
                        </div>
                     </div>
                </div>

                <div class="col-12">
                    <label class="form-label text-danger fw-bold">Liên hệ khẩn cấp / Emergency Contact <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="lien_he_khan_cap" placeholder="Tên - SĐT - Mối quan hệ" required>
                </div>

                <div class="section-header">6. Công việc & Hồ sơ / Job & Docs</div>
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Loại hợp đồng / Contract Type</label>
                        <select class="form-select" name="loai_hop_dong" id="contractType" onchange="checkContractType()">
                            <option value="Hợp đồng thỉnh giảng">Hợp đồng thỉnh giảng</option>
                            <option value="Hợp đồng chính thức">Hợp đồng chính thức</option>
                            <option value="Khác">Khác</option>
                        </select>
                        <input type="text" class="form-control mt-2 d-none" name="loai_hop_dong_khac" id="otherContract" placeholder="Nhập loại hợp đồng...">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Phòng ban / Department</label>
                        <select class="form-select" name="phong_ban">
                            <option value="Phòng NSVH">Phòng NSVH</option>
                            <option value="Phòng MKT">Phòng MKT</option>
                            <option value="Phòng Kinh doanh">Phòng Kinh doanh</option>
                            <option value="Phòng Đào tạo">Phòng Đào tạo</option>
                            <option value="Ban Lãnh Đạo">Ban Lãnh Đạo</option>
                            <option value="Phòng Tuyển sinh">Phòng Tuyển sinh</option>
                            <option value="Phòng Kế toán">Phòng Kế toán</option>
                            <option value="Thư ký khoa">Thư ký khoa</option>
                            <option value="Khoa CH">Khoa CH</option>
                            <option value="Khoa BCH">Khoa BCH</option>
                        </select>
                    </div>
                    
                    <div class="col-12 mt-4">
                        <div class="p-3 border border-primary border-2 border-dashed rounded text-center bg-white">
                            <label class="form-label fw-bold mb-2 text-primary">Ảnh hồ sơ cá nhân / Photos (Tối đa 5 ảnh) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="fileInput" multiple accept="image/*" required>
                            <small class="text-muted d-block mt-2">Hệ thống sẽ tự tạo thư mục mang tên bạn và lưu ảnh vào đó.</small>
                        </div>
                    </div>
                </div>

                <div class="btn-submit-wrapper">
                    <button type="button" class="btn btn-primary btn-submit" id="btnSubmit" onclick="submitForm()">GỬI HỒ SƠ / SUBMIT</button>
                </div>

            </form>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <h5 class="mt-3 text-primary" id="loadingText">Đang xử lý dữ liệu...</h5>
        <p class="text-muted small">Vui lòng không tắt trình duyệt.</p>
    </div>

    <script>
        // LINK APP SCRIPT CỦA BẠN (ĐÃ UPDATE THEO LIÊN KẾT BẠN CUNG CẤP)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw87HZs1wxmfICHvumBuEUv6sP6j8rg_q61zkAV5-L-HpHBcLdwr1G0b14U4xseHl4LSg/exec";

        function checkContractType() {
            const select = document.getElementById('contractType');
            const otherInput = document.getElementById('otherContract');
            if (select.value === 'Khác') {
                otherInput.classList.remove('d-none');
                otherInput.required = true;
            } else {
                otherInput.classList.add('d-none');
                otherInput.required = false;
            }
        }

        // Hàm chính gửi form
        function submitForm() {
            const form = document.getElementById('hrForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingOverlay.classList.remove('d-none');
            loadingText.innerText = "Đang kết nối Server... (Vui lòng đợi)";

            // 1. Lấy dữ liệu Text từ form
            const formData = new FormData(form);
            const dataObj = {};
            formData.forEach((value, key) => {
                if(key !== 'images') dataObj[key] = value; 
            });

            // 2. Gửi Text để lưu vào Sheet và tạo Folder
            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "cors", // Cho phép gửi request chéo domain
                headers: {
                    "Content-Type": "text/plain;charset=utf-8" // QUAN TRỌNG: Để tránh lỗi CORS Preflight
                },
                body: JSON.stringify({ action: "SAVE_INFO", payload: dataObj })
            })
            .then(response => response.json())
            .then(response => {
                if (response.status === 'SUCCESS') {
                    loadingText.innerText = "Đang lưu ảnh... (Vui lòng giữ nguyên tab)";
                    uploadPhotos(response.folderId);
                } else {
                    alert('Lỗi Server: ' + response.message);
                    loadingOverlay.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error(error);
                alert('Lỗi kết nối! Vui lòng thử lại.');
                loadingOverlay.classList.add('d-none');
            });
        }

        // Hàm upload ảnh
        async function uploadPhotos(folderId) {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const loadingText = document.getElementById('loadingText');

            if (files.length === 0) {
                finishSubmission();
                return;
            }

            let uploadedCount = 0;
            
            // Upload từng ảnh một (Tuần tự để tránh quá tải)
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                loadingText.innerText = `Đang tải ảnh ${i + 1}/${files.length}...`;
                
                try {
                    const base64Data = await convertToBase64(file);
                    
                    await fetch(SCRIPT_URL, {
                        method: "POST",
                        mode: "cors",
                        headers: {
                            "Content-Type": "text/plain;charset=utf-8"
                        },
                        body: JSON.stringify({ 
                            action: "UPLOAD_FILE", 
                            payload: {
                                folderId: folderId,
                                fileName: file.name,
                                dataStr: base64Data
                            }
                        })
                    });
                    uploadedCount++;
                } catch (err) {
                    console.error("Lỗi upload ảnh: ", file.name, err);
                }
            }
            
            finishSubmission();
        }

        // Hàm hỗ trợ chuyển file sang Base64
        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function finishSubmission() {
            document.getElementById('loadingOverlay').classList.add('d-none');
            alert("✅ XONG! Hồ sơ đã được gửi thành công.");
            document.getElementById('hrForm').reset();
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
