<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tra C·ª©u Nh√¢n S·ª± (Ch·ªâ T√¨m Theo T√™n)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f6f8; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input { padding: 12px; width: 100%; box-sizing: border-box; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; margin-top: 10px; }
        input:focus { border-color: #007bff; outline: none; }
        #status { margin-bottom: 10px; font-weight: bold; font-size: 14px; }
        .item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .item:hover { background-color: #eef; color: blue; }
        #debug-area { margin-top: 10px; padding: 10px; background: #fff3cd; color: #856404; font-size: 13px; display: none; border-radius: 4px; border: 1px solid #ffeeba; }
        
        /* Khu v·ª±c hi·ªÉn th·ªã chi ti·∫øt */
        #detail-area { background: #e8f5e9; padding: 15px; display: none; margin-top: 20px; border: 1px solid #c3e6cb; border-radius: 5px; }
        .d-row { margin-bottom: 8px; }
        .d-label { font-weight: bold; width: 140px; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <h2>üîç TRA C·ª®U NH√ÇN S·ª∞</h2>
    <div id="status" style="color:orange">‚è≥ ƒêang k·∫øt n·ªëi t·ªõi N8N...</div>
    
    <div id="debug-area"></div>

    <input type="text" id="searchInp" placeholder="Nh·∫≠p H·ªç T√™n ƒë·ªÉ t√¨m..." disabled>
    <div id="resultList"></div>

    <div id="detail-area">
        <h3>‚úÖ Th√¥ng tin chi ti·∫øt:</h3>
        <div class="d-row"><span class="d-label">H·ªç v√† T√™n:</span> <span id="out_name"></span></div>
        <div class="d-row"><span class="d-label">Email:</span> <span id="out_email"></span></div>
        <div class="d-row"><span class="d-label">SƒêT:</span> <span id="out_phone"></span></div>
        <div class="d-row"><span class="d-label">CMND/CCCD:</span> <span id="out_cmnd"></span></div>
        <div class="d-row"><span class="d-label">H·ª£p ƒë·ªìng:</span> <span id="out_contract"></span></div>
    </div>
</div>

<script>
    // üî¥ API C·ª¶A B·∫†N
    const API_URL = "https://apchn-host.lapage.vn/webhook/api-get-candidates"; 

    let database = []; 
    let NAME_KEY = ""; // Bi·∫øn l∆∞u t√™n ch√≠nh x√°c c·ªßa c·ªôt B (H·ªç T√™n)

    const statusDiv = document.getElementById('status');
    const searchInp = document.getElementById('searchInp');
    const resultList = document.getElementById('resultList');
    const detailArea = document.getElementById('detail-area');
    const debugArea = document.getElementById('debug-area');

    // 1. T·∫¢I D·ªÆ LI·ªÜU
    fetch(API_URL)
        .then(response => response.json())
        .then(data => {
            // X·ª≠ l√Ω l√†m s·∫°ch d·ªØ li·ªáu
            let rawData = [];
            if (Array.isArray(data)) rawData = data;
            else if (data.data && Array.isArray(data.data)) rawData = data.data;
            else rawData = [data];

            database = rawData.map(item => item.json ? item.json : item);

            if (database.length > 0) {
                // --- THU·∫¨T TO√ÅN T√åM C·ªòT T√äN (QUAN TR·ªåNG) ---
                // L·∫•y d√≤ng ƒë·∫ßu ti√™n ƒë·ªÉ soi t√™n c·ªôt
                const firstRow = database[0];
                const keys = Object.keys(firstRow);
                
                // T√¨m key n√†o c√≥ ch·ªØ "Name" ho·∫∑c "H·ªç v√† T√™n"
                // N8N th∆∞·ªùng tr·∫£ v·ªÅ ƒë√∫ng th·ª© t·ª±, n√™n c·ªôt B th∆∞·ªùng n·∫±m ·ªü v·ªã tr√≠ index 1 (sau Timestamp)
                // Tuy nhi√™n ta t√¨m theo t√™n cho ch·∫Øc.
                NAME_KEY = keys.find(k => k.toLowerCase().includes("name") || k.toLowerCase().includes("h·ªç v√† t√™n"));
                
                // N·∫øu kh√¥ng t√¨m th·∫•y b·∫±ng ch·ªØ, ta √©p l·∫•y c·ªôt th·ª© 2 (Index 1) v√¨ c·ªôt 1 l√† Timestamp
                if (!NAME_KEY && keys.length > 1) {
                    NAME_KEY = keys[1]; 
                }

                statusDiv.innerText = `‚úÖ ƒê√£ t·∫£i ${database.length} h·ªì s∆°.`;
                statusDiv.style.color = "green";
                searchInp.disabled = false;
                searchInp.focus();

                // HI·ªÇN TH·ªä C·ªòT M√Ä M√ÅY T√çNH ƒêANG D√ôNG ƒê·ªÇ T√åM
                debugArea.style.display = 'block';
                debugArea.innerHTML = `‚ö†Ô∏è ƒêang t√¨m ki·∫øm trong c·ªôt: <strong>[${NAME_KEY}]</strong>`;
                
            } else {
                statusDiv.innerText = "‚ö†Ô∏è D·ªØ li·ªáu r·ªóng.";
            }
        })
        .catch(err => {
            statusDiv.innerText = "‚ùå L·ªói: " + err.message;
        });

    // 2. T√åM KI·∫æM (CH·ªà T√åM TRONG C·ªòT T√äN)
    searchInp.addEventListener('input', function() {
        const keyword = this.value.toLowerCase().trim();
        resultList.innerHTML = ''; 
        detailArea.style.display = 'none';

        if (keyword.length < 1) return;

        // L·ªçc d·ªØ li·ªáu: CH·ªà SO S√ÅNH C·ªòT NAME_KEY
        const ketQua = database.filter(dong => {
            const tenNguoi = dong[NAME_KEY] || ''; // L·∫•y gi√° tr·ªã c·ªôt T√™n
            return tenNguoi.toLowerCase().includes(keyword);
        });

        if (ketQua.length === 0) {
            resultList.innerHTML = '<div style="padding:10px; color:gray">Kh√¥ng t√¨m th·∫•y ai t√™n l√† "' + keyword + '"</div>';
        } else {
            ketQua.forEach(nguoi => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerText = `üë§ ${nguoi[NAME_KEY]}`; // Ch·ªâ hi·ªán T√™n
                div.onclick = () => hienThiChiTiet(nguoi);
                resultList.appendChild(div);
            });
        }
    });

    // 3. HI·ªÇN TH·ªä CHI TI·∫æT
    function hienThiChiTiet(nguoi) {
        detailArea.style.display = 'block';
        resultList.innerHTML = ''; // X√≥a danh s√°ch g·ª£i √Ω
        
        document.getElementById('out_name').innerText = nguoi[NAME_KEY];
        
        // C√°c c·ªôt kh√°c v·∫´n l·∫•y theo t√™n b·∫°n cung c·∫•p
        document.getElementById('out_email').innerText = nguoi['Email c√° nh√¢n/ Email'] || '(Tr·ªëng)';
        document.getElementById('out_phone').innerText = nguoi['S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá/ Phone number'] || '(Tr·ªëng)';
        document.getElementById('out_cmnd').innerText = nguoi['S·ªë CMND/ ID'] || '(Tr·ªëng)';
        document.getElementById('out_contract').innerText = nguoi['Lo·∫°i H·ª£p ƒê·ªìng/ Type of Contract'] || '(Tr·ªëng)';
    }
</script>

</body>
</html>
